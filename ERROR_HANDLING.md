# üõ°Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ Telegram Bot

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

### 1. **–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ Exception –∫–ª–∞—Å—Å—ã**

–°–æ–∑–¥–∞–Ω—ã —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫:

| Exception | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |
|-----------|-------------------|
| `TelegramException` | –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö Telegram –æ—à–∏–±–æ–∫ |
| `UnauthorizedException` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–∏–≤—è–∑–∞–ª –∞–∫–∫–∞—É–Ω—Ç |
| `TaskNotFoundException` | –ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ |
| `AccountLinkException` | –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –∞–∫–∫–∞—É–Ω—Ç–∞ |
| `InvalidCommandArgumentException` | –ù–µ–≤–µ—Ä–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥—ã |
| `TelegramApiException` | –û—à–∏–±–∫–∞ Telegram API |

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `app/Exceptions/Telegram/`

---

### 2. **Try-Catch –≤–æ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö**

#### Jobs:
- ‚úÖ `ProcessTelegramUpdate` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ update
- ‚úÖ `ProcessTelegramCommand` ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥
- ‚úÖ `ProcessTelegramCallback` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫

#### Commands:
- ‚úÖ `StartCommand` ‚Äî –ø—Ä–∏–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
- ‚úÖ `AddCommand` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
- ‚úÖ `CompleteCommand` ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
- ‚úÖ –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

#### Controllers:
- ‚úÖ `TelegramWebhookController` ‚Äî –ø—Ä–∏–µ–º webhook
- ‚úÖ `TelegramAuthController` ‚Äî –≤—Å–µ 3 –º–µ—Ç–æ–¥–∞

#### Services:
- ‚úÖ `TelegramAuthService` ‚Äî —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

---

### 3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫**

–í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `storage/logs/telegram.log` —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º:

```php
\Log::channel('telegram')->error('Error message', [
    'user_id' => $userId,
    'task_id' => $taskId,
    'error' => $e->getMessage(),
    'trace' => $e->getTraceAsString(), // —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö
]);
```

**–£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**
- `error` ‚Äî –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
- `warning` ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç)
- `info` ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- `debug` ‚Äî –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

---

### 4. **–ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º**

–í–º–µ—Å—Ç–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç:

‚ùå **–ü–ª–æ—Ö–æ:**
```
Error: Call to a member function id on null
```

‚úÖ **–•–æ—Ä–æ—à–æ:**
```
‚ùå –ê–∫–∫–∞—É–Ω—Ç –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω.

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏.
```

---

## üìã –ü—Ä–∏–º–µ—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏:

### –ü—Ä–∏–º–µ—Ä 1: –ö–æ–º–∞–Ω–¥–∞ –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤

```php
// /complete (–±–µ–∑ ID)
if (count($parts) < 2 || !is_numeric($parts[1])) {
    $this->botService->sendMessage(
        $chatId,
        "‚ùå –£–∫–∞–∂–∏—Ç–µ ID –∑–∞–¥–∞—á–∏.\n\n–ü—Ä–∏–º–µ—Ä: /complete 123"
    );
    return; // Graceful exit
}
```

---

### –ü—Ä–∏–º–µ—Ä 2: –ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

```php
$task = Task::where('id', $taskId)
    ->where('user_id', $user->id)
    ->first();

if (!$task) {
    throw new TaskNotFoundException("Task {$taskId} not found");
}

// –í Job'–µ –ª–æ–≤–∏—Ç—Å—è:
catch (TaskNotFoundException $e) {
    Log::channel('telegram')->warning('Task not found', [...]);
    $botService->answerCallbackQuery($id, '–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', true);
}
```

---

### –ü—Ä–∏–º–µ—Ä 3: –û—à–∏–±–∫–∞ –ë–î –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏

```php
try {
    $task = $this->taskService->createTask($dto);
    // –£—Å–ø–µ—Ö
} catch (\Exception $e) {
    \Log::error('Error creating task via Telegram', ['error' => $e->getMessage()]);
    $this->botService->sendMessage(
        $chatId,
        "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏.\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
    );
}
```

---

### –ü—Ä–∏–º–µ—Ä 4: –ê–∫–∫–∞—É–Ω—Ç —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω

```php
try {
    $this->authService->linkAccount($userId, $telegramData);
} catch (AccountLinkException $e) {
    \Log::channel('telegram')->warning('Account link failed', [...]);
    $this->botService->sendMessage(
        $chatId,
        "‚ùå –≠—Ç–æ—Ç Telegram –∞–∫–∫–∞—É–Ω—Ç —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."
    );
}
```

---

## üîÑ Retry –º–µ—Ö–∞–Ω–∏–∑–º –≤ Jobs

–í—Å–µ Jobs –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö:

```php
public $tries = 3;               // 3 –ø–æ–ø—ã—Ç–∫–∏
public $backoff = [10, 30, 60];  // –ó–∞–¥–µ—Ä–∂–∫–∏: 10—Å, 30—Å, 60—Å
public $timeout = 120;           // –ú–∞–∫—Å–∏–º—É–º 2 –º–∏–Ω—É—Ç—ã
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. Job —É–ø–∞–ª ‚Üí –ø–æ–¥–æ–∂–¥–∞—Ç—å 10 —Å–µ–∫—É–Ω–¥ ‚Üí –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
2. –°–Ω–æ–≤–∞ —É–ø–∞–ª ‚Üí –ø–æ–¥–æ–∂–¥–∞—Ç—å 30 —Å–µ–∫—É–Ω–¥ ‚Üí –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
3. –°–Ω–æ–≤–∞ —É–ø–∞–ª ‚Üí –ø–æ–¥–æ–∂–¥–∞—Ç—å 60 —Å–µ–∫—É–Ω–¥ ‚Üí –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
4. –ï—Å–ª–∏ –≤—Å–µ 3 –ø–æ–ø—ã—Ç–∫–∏ failed ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `failed()` –º–µ—Ç–æ–¥ ‚Üí –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è

---

## üìä –¢–∏–ø—ã –æ—à–∏–±–æ–∫ –∏ –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∞:

| –¢–∏–ø –æ—à–∏–±–∫–∏ | –ì–¥–µ –ª–æ–≤–∏—Ç—Å—è | –î–µ–π—Å—Ç–≤–∏–µ | Retry? |
|------------|-------------|----------|--------|
| –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ | Command | –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é | ‚ùå |
| –ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ | Callback Job | Callback alert | ‚ùå |
| –û—à–∏–±–∫–∞ –ë–î | –í–µ–∑–¥–µ | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ + —Å–æ–æ–±—â–µ–Ω–∏–µ | ‚úÖ |
| Timeout Telegram API | –í–µ–∑–¥–µ | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ + retry | ‚úÖ |
| –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã | Command | –°–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∏–º–µ—Ä–æ–º | ‚ùå |
| –î—É–±–ª–∏–∫–∞—Ç –ø—Ä–∏–≤—è–∑–∫–∏ | Auth Service | –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ | ‚ùå |

---

## üéØ Best Practices:

### 1. –í—Å–µ–≥–¥–∞ –ª–æ–≥–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç:
```php
\Log::channel('telegram')->error('Message', [
    'user_id' => $userId,      // –ö—Ç–æ
    'task_id' => $taskId,      // –ß—Ç–æ
    'action' => 'complete',    // –î–µ–π—Å—Ç–≤–∏–µ
    'error' => $e->getMessage() // –û—à–∏–±–∫–∞
]);
```

### 2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è:
```php
// ‚ùå –ü–ª–æ—Ö–æ
throw new \Exception('Task not found');

// ‚úÖ –•–æ—Ä–æ—à–æ
throw new TaskNotFoundException("Task {$id} not found");
```

### 3. –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
```php
try {
    // –û–ø–µ—Ä–∞—Ü–∏—è
} catch (\Exception $e) {
    \Log::error(...);
    // –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:
    $this->botService->sendMessage($chatId, "‚ùå –û—à–∏–±–∫–∞...");
}
```

### 4. –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:
```php
// ‚ùå –ü–ª–æ—Ö–æ
"Error: SQLSTATE[HY000]: General error: 2006 MySQL server has gone away"

// ‚úÖ –•–æ—Ä–æ—à–æ
"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
```

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫:

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:
```bash
tail -f storage/logs/telegram.log
```

### –§–∏–ª—å—Ç—Ä —Ç–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫:
```bash
tail -f storage/logs/telegram.log | grep ERROR
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä failed jobs:
```bash
php artisan queue:failed
```

### Retry failed jobs:
```bash
php artisan queue:retry all
```

---

## ‚úÖ –ò—Ç–æ–≥:

- ‚úÖ **6 —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö Exception –∫–ª–∞—Å—Å–æ–≤**
- ‚úÖ **Try-catch –≤–æ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö**
- ‚úÖ **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º**
- ‚úÖ **–ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º**
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ retry –ø—Ä–∏ —Å–±–æ—è—Ö**
- ‚úÖ **Graceful degradation** ‚Äî –±–æ—Ç –Ω–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª

**–ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ production! –í—Å–µ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ.** üéâ
